- name: include vars
  include_vars: "vars_mysql.yml"

# 校验 mysql 节点通信状态
- name: validating mysql instances
  stat:
    path: "{{ mysql_script_dir }}/mysql_cluster_validating.sql"
  register: check_result
  check_mode: no
  when: inventory_hostname == '10.1.207.180'
- name: create validating mysql instances file
  lineinfile:
    dest: "{{ mysql_script_dir }}/mysql_cluster_validating.sql"
    line: "dba.checkInstanceConfiguration('root@{{ hosts[item] }}:{{ mysqld_port }}',{'password': '{{ mysql_user_root_password }}', 'interactive': false})"
    state: present
    create: true
  with_items: "{{ groups.all }}"
  check_mode: no
  when: when: inventory_hostname == '10.1.207.180' and not check_result.stat.exists
- name: exec validating mysql instances
  shell: "source ~/.bash_profile && mysqlsh --no-password < {{ mysql_script_dir }}/mysql_cluster_validating.sql"
  check_mode: no
  register: check_result
  when: not check_result.stat.exists

# 创建 mysql 集群主节点
- name: validating mysql cluster script
  stat:
    path: "{{ mysql_script_dir }}/mysql_cluster_init.sql"
  check_mode: no
  register: check_result
  when: inventory_hostname == '10.1.207.180'
- name: create validating mysql cluster script
  lineinfile:
    dest: "{{ mysql_script_dir }}/mysql_cluster_init.sql"
    line: "{{ item }}"
    state: present
    create: true
  with_items: |
    shell.connect('root@10.1.207.180:{{ mysqld_port }}', '{{ mysql_user_root_password }}')
    shell.options['dba.restartWaitTimeout']=7200
    dba.createCluster('{{ cluster_name }}', {'localAddress': '10.1.207.180'})
    var cluster=dba.getCluster('{{ cluster_name }}')
    cluster.addInstance('root@10.1.207.181:{{ mysqld_port }}', {'localAddress': '10.1.207.181', 'password': '{{ mysql_user_root_password }}','recoveryMethod':'clone','waitRecovery':'1'})
    cluster.addInstance('root@10.1.207.182:{{ mysqld_port }}', {'localAddress': '10.1.207.182', 'password': '{{ mysql_user_root_password }}','recoveryMethod':'clone','waitRecovery':'1'})
  #when: (not check_result.stat.exists) and ({{ cluster_master }} = true)
  when: inventory_hostname == '10.1.207.180' and not check_result.stat.exists
  check_mode: no
