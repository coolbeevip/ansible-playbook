- name: include vars
  include_vars: "vars_antdb.yml"

# 创建 antdb 安装根目录
- name: create antdb home
  file:
    path: "{{ antdb_home_dir }}"
    state: directory
    owner: "{{ antdb_user }}"
    group: "{{ antdb_group }}"
    mode: "2750"
  become: yes
  check_mode: no
  when: inventory_hostname == antdb_mgr_primary

# 创建 antdb 数据目录
- name: create others directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ antdb_user }}"
    group: "{{ antdb_group }}"
    mode: "2750"
  with_items:
    - "{{ antdb_mgr_dir }}"
    - "{{ antdb_data_dir }}"
    - "{{ antdb_tools_dir }}"
    - "{{ antdb_app_dir }}"
    - "{{ antdb_core_dir }}"
  check_mode: no
  become: yes
  when: inventory_hostname == antdb_mgr_primary

# 上传卸载脚本 antdb_uninstall.sh
- name: copy antdb_uninstall.sh
  template:
    src: "/ansible-playbook/antdb/config/antdb_uninstall.sh.j2"
    dest: "$HOME/antdb_uninstall.sh"
    mode: u=rwx,g=rx,o=rx
  check_mode: no

# 上传 mysql 安装包
- name: check upload antdb
  stat:
    path: "{{ antdb_home_dir }}/{{ antdb_tar }}"
  register: check_result
  check_mode: no
- name: upload antdb
  synchronize:
    src: "/ansible-playbook/packages/{{ antdb_tar }}"
    dest: "{{ antdb_home_dir }}/{{ antdb_tar }}"
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (not check_result.stat.exists)

# Install rpm package
- name: Check install rpm package
  stat:
    path: "$ADB_HOME/bin"
  register: check_result
  check_mode: no
  when: inventory_hostname == antdb_mgr_primary
- name: Install rpm package
  shell: rpm -ivh {{ antdb_home_dir }}/{{ antdb_tar }} --relocate=/opt/app/antdb=$ADB_HOME
  check_mode: no
  become: yes
  when: (inventory_hostname == antdb_mgr_primary) and (not check_result.stat.exists)
- name: Change rpm file permission
  file:
    path: $ADB_HOME
    owner: "{{ antdb_user }}"
    group: "{{ antdb_group }}"
    recurse: true
    state: directory
    mode: "2755"
  check_mode: no
  become: yes
  when: (inventory_hostname == antdb_mgr_primary) and (not check_result.stat.exists)

# Initialize MGR
- name: Check initialize MGR
  stat:
    path: "{{ antdb_mgr_dir }}/postgresql.conf"
  register: check_result
  check_mode: no
- name: Initialize MGR
  shell: initmgr -D $mgrdata
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (not check_result.stat.exists)

# Configuring postgresql.conf
- name: Configuring postgresql.conf listen_addresses
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^listen_addresses.*'
    line: "listen_addresses = '{{ antdb_conf_listen_addresses }}'"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf port
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^port.*'
    line: "port = {{ antdb_conf_port }}"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf log_destination
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^log_destination.*'
    line: "log_destination = '{{ antdb_conf_log_destination }}'"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf logging_collector
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^logging_collector.*'
    line: "logging_collector = {{ antdb_conf_logging_collector }}"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf log_directory
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^log_directory.*'
    line: "log_directory = '{{ antdb_conf_log_directory }}'"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf log_rotation_size
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^log_rotation_size.*'
    line: "log_rotation_size = {{ antdb_conf_log_rotation_size }}"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf log_min_messages
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^log_min_messages.*'
    line: "log_min_messages = {{ antdb_conf_log_min_messages }}"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
- name: Configuring postgresql.conf log_statement
  lineinfile:
    dest: "{{ antdb_mgr_dir }}/postgresql.conf"
    regexp: '^log_statement.*'
    line: "log_statement = {{ antdb_conf_log_statement }}"
    state: present
  check_mode: no
  when: (inventory_hostname == antdb_mgr_primary) and (check_result.stat.exists)
