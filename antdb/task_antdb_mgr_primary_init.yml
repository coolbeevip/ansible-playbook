# MGR 主节点初始化
- name: include vars
  include_vars: "vars_antdb.yml"

# 重启 MGR 节点
- name: Stop Mgr Primary Node
  shell: "source ~/.bashrc && mgr_ctl stop -D $mgrdata -m fast"
  check_mode: no
  when: inventory_hostname == antdb_mgr_primary
- name: Start Mgr Primary Node
  shell: "source ~/.bashrc && mgr_ctl start -D $mgrdata"
  check_mode: no
  when: inventory_hostname == antdb_mgr_primary

# 添加主机信息
- name: Add hosts to MGR
  #debug:
  #  msg: adbmgr -c "add host {{ node_names[item].name }}(port=22022, protocol='ssh', adbhome='{{ antdb_app_dir }}', address='{{ item }}', agentport={{ andb_agent_port }}, user='{{ antdb_user }}');"
  shell: psql -p 16432 -d postgres -c "add host {{ node_names[item].name }}(port=22022, protocol='ssh', adbhome='{{ antdb_app_dir }}', address='{{ item }}', agentport={{ andb_agent_port }}, user='{{ antdb_user }}');"
  check_mode: no
  with_items: "{{ groups.all }}"
  when: inventory_hostname == antdb_mgr_primary

# 添加 GTM 节点
- name: Add GTM master to MGR
  debug:
    msg: adbmgr -c "add gtmcoord master {{ gtm_nodes.master.name }}(host='{{ gtm_nodes.master.node }}', port={{ antdb_gtm_port }}, path='{{ antdb_data_dir }}/{{ gtm_nodes.master.name }}');"
  check_mode: no
  when: inventory_hostname == antdb_mgr_primary
- name: Add GTM slave to MGR
  debug:
    msg: adbmgr -c "add gtmcoord slave {{ item.name }} for {{ gtm_nodes.master.name }}(host='{{ item.node }}', port={{ antdb_gtm_port }}, path='{{ antdb_data_dir }}/{{ item.name }}');"
  check_mode: no
  with_items: "{{ gtm_nodes.slaves }}"
  when: inventory_hostname == antdb_mgr_primary

# 添加 Coordinator 节点
- name: Add Coordinator to MGR
  debug:
    msg: adbmgr -c "add coordinator master {{ item.name }}(host='{{ item.node }}', port={{ antdb_coordinator_port }}, path='{{ antdb_data_dir }}/{{ item.name }}');"
  check_mode: no
  with_items: "{{ coordinator_nodes }}"
  when: inventory_hostname == antdb_mgr_primary

# 添加 Data 节点
- name: Add DataNode to MGR
  debug:
    msg:
      - adbmgr -c "add datanode master {{ item.master.name }}(host='{{ item.master.node }}', port={{ antdb_datanode_port }}, path='{{ antdb_data_dir }}/{{ item.master.name }}');"
      - adbmgr -c "add datanode slave {{ item.slave.name }} for {{ item.master.name }}(host='{{ item.master.node }}', port={{ antdb_datanode_port }}, path='{{ antdb_data_dir }}/{{ item.slave.name }}');"
  check_mode: no
  with_items: "{{ data_nodes }}"
  when: inventory_hostname == antdb_mgr_primary
